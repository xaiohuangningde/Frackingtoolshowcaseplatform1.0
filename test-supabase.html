<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #3367d6;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>Supabase 连接测试</h1>
    
    <div class="test-section">
        <h2>基本连接测试</h2>
        <button onclick="testBasicConnection()">测试基本连接</button>
        <button onclick="testRESTAPI()">测试 REST API</button>
        <div id="connection-status"></div>
    </div>
    
    <div class="test-section">
        <h2>数据操作测试</h2>
        <button onclick="testCreateTable()">创建数据表</button>
        <button onclick="testInsertData()">插入测试数据</button>
        <button onclick="testGetData()">获取数据</button>
        <div id="data-status"></div>
    </div>
    
    <div class="test-section">
        <h2>项目配置信息</h2>
        <div>
            <p>项目 URL: https://daqqydhbydcgwxsyxyis.supabase.co</p>
            <p>API 密钥已设置</p>
        </div>
    </div>

    <script>
        const SUPABASE_PROJECT_ID = "daqqydhbydcgwxsyxyis";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhcXF5ZGhieWRjZ3d4c3l4eWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NjQ3MzUsImV4cCI6MjA4MDA0MDczNX0.2fP-fsLkQ0GIMEhRMMlMzCAAqGYr_ZpuGSUIi0XMmY4";
        const REST_API_URL = `https://${SUPABASE_PROJECT_ID}.supabase.co/rest/v1`;
        const HEADERS = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
        };
        
        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        async function testBasicConnection() {
            showStatus('connection-status', '正在测试基本连接...', 'info');
            
            try {
                const response = await fetch(`https://${SUPABASE_PROJECT_ID}.supabase.co/rest/v1/`, {
                    method: 'GET',
                    headers: HEADERS
                });
                
                if (response.ok) {
                    showStatus('connection-status', '✅ Supabase 基本连接成功！', 'success');
                } else {
                    showStatus('connection-status', `❌ 连接失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('connection-status', `❌ 连接错误: ${error.message}`, 'error');
            }
        }
        
        async function testRESTAPI() {
            showStatus('connection-status', '正在测试 REST API...', 'info');
            
            try {
                const response = await fetch(`${REST_API_URL}/fracking_tools`, {
                    method: 'GET',
                    headers: HEADERS
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('connection-status', `✅ REST API 连接成功！找到 ${data.length} 条工具记录`, 'success');
                } else if (response.status === 406 || response.status === 404) {
                    showStatus('connection-status', '✅ REST API 连接成功！数据表不存在（这是正常的）', 'success');
                } else {
                    showStatus('connection-status', `❌ REST API 失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('connection-status', `❌ REST API 错误: ${error.message}`, 'error');
            }
        }
        
        async function testCreateTable() {
            showStatus('data-status', '正在创建数据表...', 'info');
            
            try {
                const response = await fetch(`https://${SUPABASE_PROJECT_ID}.supabase.co/rest/v1/rpc/execute_sql`, {
                    method: 'POST',
                    headers: HEADERS,
                    body: JSON.stringify({
                        sql: `
                            CREATE TABLE IF NOT EXISTS fracking_tools (
                                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                                name TEXT NOT NULL,
                                "group" TEXT NOT NULL,
                                description TEXT DEFAULT '',
                                poster_url TEXT NOT NULL,
                                model_url TEXT NOT NULL,
                                created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                            );
                        `
                    })
                });
                
                if (response.ok) {
                    showStatus('data-status', '✅ 数据表创建成功！请手动在 Supabase 控制台中设置 RLS 策略', 'success');
                } else {
                    showStatus('data-status', `❌ 数据表创建失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('data-status', `❌ 数据表创建错误: ${error.message}`, 'error');
            }
        }
        
        async function testInsertData() {
            showStatus('data-status', '正在插入测试数据...', 'info');
            
            try {
                const testData = {
                    name: '测试工具-' + new Date().getTime(),
                    group: '测试分组',
                    description: '这是一个测试工具',
                    poster_url: 'https://example.com/poster.jpg',
                    model_url: 'https://example.com/model.glb'
                };
                
                const response = await fetch(`${REST_API_URL}/fracking_tools`, {
                    method: 'POST',
                    headers: HEADERS,
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('data-status', `✅ 测试数据插入成功！ID: ${data[0].id}`, 'success');
                } else {
                    showStatus('data-status', `❌ 数据插入失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('data-status', `❌ 数据插入错误: ${error.message}`, 'error');
            }
        }
        
        async function testGetData() {
            showStatus('data-status', '正在获取数据...', 'info');
            
            try {
                const response = await fetch(`${REST_API_URL}/fracking_tools?order=created_at.desc`, {
                    method: 'GET',
                    headers: HEADERS
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('data-status', `✅ 数据获取成功！共 ${data.length} 条记录`, 'success');
                    
                    // 显示前5条记录
                    if (data.length > 0) {
                        const preview = data.slice(0, 5).map(item => `${item.name} (${item.group})`).join(', ');
                        showStatus('data-status', `预览: ${preview}`, 'info');
                    }
                } else {
                    showStatus('data-status', `❌ 数据获取失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showStatus('data-status', `❌ 数据获取错误: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动测试基本连接
        window.onload = function() {
            testBasicConnection();
        };
    </script>
</body>
</html>